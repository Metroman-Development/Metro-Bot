### **Manual de Mantenimiento y Depuraci贸n para `presenceUpdater.js`**

Este manual proporciona una gu铆a completa para el mantenimiento y depuraci贸n del m贸dulo `presenceUpdater.js`. Incluye detalles sobre las variables esperadas, flujo de datos, y c贸mo solucionar problemas comunes.

---

## **ndice**

1. **Descripci贸n del M贸dulo**

2. **Variables Esperadas**

3. **Flujo de Datos**

4. **Gu铆a de Depuraci贸n**

5. **Problemas Comunes y Soluciones**

6. **Recomendaciones de Mantenimiento**

---

## **1. Descripci贸n del M贸dulo**

El m贸dulo `presenceUpdater.js` se encarga de actualizar el estado de presencia del bot de Discord (`Presence`) en funci贸n del estado actual de la red del Metro. Utiliza datos proporcionados por `changeDetector.js` y `metroDataHandler.js` para generar mensajes din谩micos que reflejan el estado de la red.

### **Funcionalidades Clave:**

- Actualiza el estado de presencia cada 30 segundos.

- Muestra mensajes personalizados seg煤n el estado de la red:

  - **Cierre por Horario**: Si todas las l铆neas/estaciones est谩n en `estado 0`.

  - **Red Operativa**: Si todas las l铆neas/estaciones est谩n en `estado 1`.

  - **Incidencias**: Si hay l铆neas o estaciones en `estado 2-5`.

  - **Mensajes Gen茅ricos**: Mensajes predefinidos (e.g., "Pr贸xima Estaci贸n: X").

- Ajusta din谩micamente los pesos de los mensajes seg煤n el estado de la red.

---

## **2. Variables Esperadas**

### **Variables de Configuraci贸n (`PRESENCE_CONFIG`):**

- **`updateInterval`**: Intervalo de tiempo (en milisegundos) para actualizar la presencia. Valor predeterminado: `30000` (30 segundos).

- **`messages.redInfo.baseWeight`**: Peso base para mostrar mensajes de incidencias. Valor predeterminado: `0.5`.

- **`messages.redInfo.operationalWeight`**: Peso para mensajes de incidencias cuando la red est谩 operativa. Valor predeterminado: `0.25`.

- **`messages.generic`**: Lista de mensajes gen茅ricos con sus pesos. Ejemplo:

  ```javascript

  { text: 'Pr贸xima Estaci贸n: ', weight: 0.2 }

  ```

### **Variables de Entrada:**

- **`client`**: Objeto de cliente de Discord.js, proporcionado al llamar a `initializePresenceUpdates`.

- **`initialData`**: Datos iniciales de la red del Metro (opcional).

### **Variables de Salida:**

- **Estado de Presencia**: Mensajes generados din谩micamente para el estado de presencia del bot.

---

## **3. Flujo de Datos**

1. **Inicializaci贸n**:

   - Se llama a `initializePresenceUpdates(client, initialData)`.

   - Se configura un intervalo para actualizar la presencia cada `updateInterval`.

2. **Actualizaci贸n de Presencia**:

   - Se llama a `buildStatusMessage()` para generar un mensaje basado en el estado de la red.

   - Se utiliza `changeDetector.getNetworkStatus()` para determinar el estado general de la red.

   - Se utiliza `changeDetector.getStatusSummary()` para obtener detalles sobre incidencias.

3. **Generaci贸n de Mensajes**:

   - Si la red est谩 cerrada (`estado 0`), se muestra "Cierre por Horario".

   - Si la red est谩 operativa (`estado 1`), se muestra "Toda la Red Operativa".

   - Si hay incidencias (`estado 2-5`), se selecciona un mensaje aleatorio del `statusSummary`.

   - Si no hay incidencias, se muestra un mensaje gen茅rico.

4. **Actualizaci贸n del Estado**:

   - Se actualiza el estado de presencia del bot usando `client.user.setPresence`.

---

## **4. Gu铆a de Depuraci贸n**

### **Herramientas Recomendadas:**

- **Logs**: Use `logger.debug` y `logger.error` para rastrear el flujo de ejecuci贸n y errores.

- **Depuraci贸n en Tiempo Real**: Use un IDE como Visual Studio Code con breakpoints para inspeccionar variables.

### **Pasos para Depurar:**

1. **Verifique los Logs**:

   - Aseg煤rese de que los logs est茅n habilitados y revisar mensajes como `Updated presence to: [mensaje]` o `Failed to update presence: [error]`.

2. **Revise el Estado de la Red**:

   - Use `changeDetector.getNetworkStatus()` para verificar el estado actual de la red.

   - Use `changeDetector.getStatusSummary()` para inspeccionar las incidencias detectadas.

3. **Simule Estados de la Red**:

   - Modifique los datos de prueba en `metroDataHandler.js` para simular diferentes estados de la red (e.g., `estado 0`, `estado 1`, `estado 2-5`).

4. **Verifique los Mensajes Generados**:

   - Aseg煤rese de que `buildStatusMessage()` est茅 generando mensajes correctos para cada estado de la red.

---

## **5. Problemas Comunes y Soluciones**

### **Problema 1: El bot no actualiza su presencia.**

- **Causa**: El intervalo de actualizaci贸n no se est谩 ejecutando.

- **Soluci贸n**:

  - Verifique que `initializePresenceUpdates` se est茅 llamando correctamente.

  - Aseg煤rese de que el cliente de Discord est茅 conectado.

### **Problema 2: Los mensajes de incidencias no se muestran.**

- **Causa**: El peso (`weight`) para mensajes de incidencias es demasiado bajo.

- **Soluci贸n**:

  - Aumente `PRESENCE_CONFIG.messages.redInfo.baseWeight` o `operationalWeight`.

### **Problema 3: Mensajes gen茅ricos no se muestran.**

- **Causa**: Los pesos de los mensajes gen茅ricos no est谩n bien configurados.

- **Soluci贸n**:

  - Verifique que la suma de los pesos en `PRESENCE_CONFIG.messages.generic` sea `1`.

### **Problema 4: El bot muestra "Red Metro de Santiago" en lugar de mensajes espec铆ficos.**

- **Causa**: No se encontraron incidencias ni mensajes gen茅ricos v谩lidos.

- **Soluci贸n**:

  - Revise que `changeDetector.getStatusSummary()` est茅 devolviendo datos correctos.

  - Aseg煤rese de que `getRandomStation()` est茅 funcionando correctamente.

---

## **6. Recomendaciones de Mantenimiento**

1. **Mantenga Actualizadas las Dependencias**:

   - Aseg煤rese de que `discord.js`, `logger`, `changeDetector`, y `metroDataHandler` est茅n actualizados.

2. **Pruebas Regulares**:

   - Simule diferentes estados de la red para asegurarse de que los mensajes se generen correctamente.

3. **Documentaci贸n de Cambios**:

   - Documente cualquier cambio en los pesos de los mensajes o la l贸gica de generaci贸n de mensajes.

4. **Monitoreo de Logs**:

   - Revise los logs regularmente para detectar errores o comportamientos inesperados.

5. **Optimizaci贸n de Pesos**:

   - Ajuste los pesos de los mensajes (`baseWeight`, `operationalWeight`, y pesos gen茅ricos) seg煤n las necesidades del proyecto.

---

### **Ejemplo de Configuraci贸n Final**

```javascript

const PRESENCE_CONFIG = {

    updateInterval: 30000,

    messages: {

        redInfo: { 

            baseWeight: 0.5,

            operationalWeight: 0.25

        },

        generic: [

            { text: 'T贸mate siempre del pasamanos o manilla', weight: 0.05 },

            { text: 'Usa /help', weight: 0.05 },

            { text: 'Precauci贸n: Se Inicia el Cierre de Puertas', weight: 0.05 },

            { text: 'Mantente detr谩s de la L铆nea Amarilla', weight: 0.05 },

            { text: 'S谩quenme de Baquedano', weight: 0.1 },

            { text: 'Pr贸xima Estaci贸n: ', weight: 0.2 }

        ]

    }

};

```

---

隆Entendido! Vamos a a帽adir una secci贸n detallada sobre el **diccionario `statusSummary`**, que es una parte clave del m贸dulo `changeDetector.js` y se utiliza en `presenceUpdater.js` para generar mensajes de estado. Este diccionario es fundamental para entender c贸mo se estructuran los datos de incidencias y c贸mo se utilizan en el sistema.

---

## **7. Diccionario `statusSummary`**

El diccionario `statusSummary` es un objeto que contiene informaci贸n sobre el estado actual de la red del Metro, incluyendo incidencias en l铆neas y estaciones. Su estructura es la siguiente:

### **Estructura del Diccionario:**

```javascript

{

    hasEstado0: boolean, // Indica si alguna l铆nea o estaci贸n est谩 en estado 0 (cierre por horario)

    messages: {

        [mensaje_app]: {

            lines: string[], // L铆neas afectadas por este mensaje

            stations: {

                [l铆nea]: string[] // Estaciones afectadas en una l铆nea espec铆fica

            }

        }

    }

}

```

### **Campos Explicados:**

1. **`hasEstado0`**:

   - Tipo: `boolean`.

   - Descripci贸n: Indica si alguna l铆nea o estaci贸n est谩 en `estado 0` (cierre por horario).

   - Ejemplo:

     ```javascript

     hasEstado0: true // Indica que la red est谩 cerrada.

     ```

2. **`messages`**:

   - Tipo: `object`.

   - Descripci贸n: Contiene mensajes de incidencias agrupados por `mensaje_app` (descripci贸n de la incidencia).

   - Estructura:

     ```javascript

     {

         [mensaje_app]: {

             lines: string[], // L铆neas afectadas por este mensaje

             stations: {

                 [l铆nea]: string[] // Estaciones afectadas en una l铆nea espec铆fica

             }

         }

     }

     ```

3. **`lines`**:

   - Tipo: `string[]`.

   - Descripci贸n: Lista de l铆neas afectadas por el mensaje de incidencia.

   - Ejemplo:

     ```javascript

     lines: ["L1", "L5"] // L铆neas L1 y L5 est谩n afectadas.

     ```

4. **`stations`**:

   - Tipo: `object`.

   - Descripci贸n: Estaciones afectadas agrupadas por l铆nea.

   - Estructura:

     ```javascript

     {

         [l铆nea]: string[] // Lista de estaciones afectadas en la l铆nea

     }

     ```

   - Ejemplo:

     ```javascript

     stations: {

         "L1": ["San Pablo", "Los H茅roes"], // Estaciones afectadas en L1

         "L5": ["Plaza de Maip煤"] // Estaciones afectadas en L5

     }

     ```

---

### **Ejemplo Completo de `statusSummary`**

```javascript

{

    hasEstado0: false, // La red no est谩 cerrada

    messages: {

        "Demora por mantenci贸n programada": {

            lines: ["L1", "L5"], // L铆neas afectadas

            stations: {

                "L1": ["San Pablo", "Los H茅roes"], // Estaciones afectadas en L1

                "L5": ["Plaza de Maip煤"] // Estaciones afectadas en L5

            }

        },

        "Cierre temporal por manifestaci贸n": {

            lines: ["L2"], // L铆neas afectadas

            stations: {

                "L2": ["Santa Ana", "Los H茅roes"] // Estaciones afectadas en L2

            }

        }

    }

}

```

---

### **C贸mo se Usa en `presenceUpdater.js`**

El diccionario `statusSummary` se utiliza en la funci贸n `buildStatusMessage()` para generar mensajes de estado din谩micos. Aqu铆 hay un desglose de c贸mo se usa:

1. **Verificaci贸n de `hasEstado0`**:

   - Si `hasEstado0` es `true`, se muestra "Cierre por Horario".

2. **Verificaci贸n de `messages`**:

   - Si hay mensajes en `messages`, se selecciona uno aleatorio y se formatea:

     - Para l铆neas: `L铆nea X: [mensaje_app]`.

     - Para estaciones: `L铆nea X estaciones: [mensaje_app]`.

3. **Mensajes Gen茅ricos**:

   - Si no hay incidencias (`messages` est谩 vac铆o), se muestra un mensaje gen茅rico.

---

### **Ejemplo de Uso en `buildStatusMessage()`**

```javascript

function buildStatusMessage() {

    const networkStatus = changeDetector.getNetworkStatus();

    const statusSummary = changeDetector.getStatusSummary();

    // Cierre por Horario

    if (networkStatus === 'closure') {

        return 'Cierre por Horario';

    }

    // Red Operativa

    if (networkStatus === 'operational') {

        return 'Toda la Red Operativa';

    }

    // Incidencias

    const messages = Object.entries(statusSummary.messages);

    if (messages.length > 0) {

        const [msgKey, msgData] = messages[Math.floor(Math.random() * messages.length)];

        

        // Prioriza l铆neas sobre estaciones

        if (msgData.lines.length > 0) {

            const line = msgData.lines[Math.floor(Math.random() * msgData.lines.length)];

            return `L铆nea ${line}: ${msgKey}`;

        }

        // Estaciones

        if (Object.keys(msgData.stations).length > 0) {

            const line = Object.keys(msgData.stations)[0];

            return `L铆nea ${line} estaciones: ${msgKey}`;

        }

    }

    // Mensajes gen茅ricos

    const totalWeight = PRESENCE_CONFIG.messages.generic.reduce((sum, m) => sum + m.weight, 0);

    let random = Math.random() * totalWeight;

    for (const msg of PRESENCE_CONFIG.messages.generic) {

        if (random < msg.weight) {

            if (msg.text.startsWith('Pr贸xima Estaci贸n')) {

                const station = getRandomStation();

                return station ? `${msg.text}${station}` : 'Red Metro de Santiago';

            }

            return msg.text;

        }

        random -= msg.weight;

    }

    return 'Red Metro de Santiago';

}

```

---

### **Resumen del Diccionario `statusSummary`**

- **Prop贸sito**: Almacena informaci贸n sobre incidencias en la red del Metro.

- **Estructura**: Agrupa l铆neas y estaciones afectadas por mensajes de incidencia (`mensaje_app`).

- **Uso**: Se utiliza en `presenceUpdater.js` para generar mensajes de estado din谩micos.

Este diccionario es esencial para entender c贸mo se gestionan y muestran las incidencias en el sistema. Si tienes m谩s preguntas o necesitas m谩s detalles, 隆no dudes en preguntar!  

