### **Explicaci贸n del Sistema: `stationUtils`, `searchUtils` y `dataUtils`**

Este documento explica la arquitectura y funcionalidad de los tres m贸dulos principales (`stationUtils`, `searchUtils` y `dataUtils`) que conforman el sistema de b煤squeda y recuperaci贸n de informaci贸n de estaciones de metro. Estos m贸dulos trabajan juntos para proporcionar una experiencia fluida al buscar y mostrar informaci贸n de estaciones.

---

### **1. `dataUtils` - Carga y Gesti贸n de Datos**

#### **Prop贸sito:**
- **Cargar y preprocesar los datos de las estaciones** desde archivos JSON.
- **Proporcionar acceso a los datos de las estaciones** mediante funciones utilitarias como `getStation` y `getAllStations`.

#### **Funciones Clave:**

1. **`loadStationData()`**:
   - Carga los datos de las estaciones desde `stations.json` y `stationsData.json`.
   - Preprocesa los datos en un formato estructurado para consultas eficientes.
   - Almacena en cach茅 los datos preprocesados en memoria para acceso r谩pido.

2. **`getStation(identificador)`**:
   - Recupera informaci贸n detallada de una estaci贸n espec铆fica utilizando su **nombre normalizado**.
   - Admite coincidencias exactas, normalizadas y fon茅ticas para b煤squedas flexibles.

3. **`getAllStations()`**:
   - Devuelve todos los datos de las estaciones preprocesados como un objeto estructurado.
   - Utilizado por `searchUtils` para realizar b煤squedas en todas las estaciones.

#### **Estructura de Datos:**

- **`stations`**: Un mapa de todas las estaciones, indexado por sus **nombres normalizados**.
- **`normalizedMap`**: Un mapa que vincula nombres normalizados a objetos de estaci贸n.
- **`routeMap`**: Un mapa que agrupa las estaciones por sus rutas.

#### **Ejemplo:**

```javascript
const station = getStation("sanpablol1");
// Devuelve:
{
  original: "San Pablo L1",
  normalized: "sanpablol1",
  line: "1",
  transfer: "5",
  status: { description: "Habilitada" },
  details: { services: ["ATM", "WiFi"], accessibility: "Accesible" }
}
```

---

### **2. `searchUtils` - L贸gica de B煤squeda y Coincidencias**

#### **Prop贸sito:**
- Realizar **b煤squedas profundas** de estaciones utilizando m煤ltiples estrategias de coincidencia (exacta, parcial, fon茅tica).
- Manejar **desambiguaci贸n** cuando se encuentran m煤ltiples coincidencias.
- Devolver coincidencias en un formato compatible con `dataUtils`.

#### **Funciones Clave:**

1. **`deepSearch(query, options)`**:
   - Busca estaciones que coincidan con la consulta.
   - Admite **filtrado por l铆nea** (por ejemplo, "San Pablo L1").
   - Devuelve coincidencias ordenadas por relevancia (puntaje).

2. **`fuzzySearch(query, stations, options)`**:
   - Realiza coincidencias aproximadas utilizando **similitud de cadenas** y **coincidencia fon茅tica**.
   - Filtra los resultados por un umbral m铆nimo de similitud (por defecto: 0.75).

3. **`findExactMatches(query)`**:
   - Encuentra coincidencias exactas utilizando el **nombre normalizado**.

4. **`findPartialMatches(query)`**:
   - Encuentra coincidencias parciales utilizando **coincidencias de subcadenas**.

#### **Estrategias de Coincidencia:**

1. **Coincidencia Exacta**:
   - Compara la consulta directamente con el **nombre normalizado** de cada estaci贸n.

2. **Coincidencia Parcial**:
   - Verifica si la consulta es una subcadena del nombre de la estaci贸n o viceversa.

3. **Coincidencia Fon茅tica**:
   - Utiliza el **algoritmo Metaphone** para comparar la representaci贸n fon茅tica de la consulta y los nombres de las estaciones.

#### **Ejemplo:**

```javascript
const matches = deepSearch("San Pablo");
// Devuelve:
[
  {
    name: "San Pablo L1",
    normalized: "sanpablol1",
    line: "1",
    score: 1.0
  },
  {
    name: "San Pablo L5",
    normalized: "sanpablol5",
    line: "5",
    score: 0.9
  }
]
```

---

### **3. `stationUtils` - Manejo de Comandos y Creaci贸n de Embeds**

#### **Prop贸sito:**
- Manejar el comando `/estacion` en Discord.
- Mostrar informaci贸n de la estaci贸n en un **embed**.
- Utilizar `searchUtils` y `dataUtils` para obtener y formatear los datos.

#### **Funciones Clave:**

1. **`autocomplete(interaction)`**:
   - Proporciona sugerencias de autocompletado para los nombres de las estaciones.
   - Utiliza `deepSearch` para encontrar coincidencias para la entrada del usuario.

2. **`execute(interaction)`**:
   - Procesa la consulta del usuario.
   - Utiliza `deepSearch` para encontrar la mejor coincidencia.
   - Obtiene datos detallados de la estaci贸n utilizando `getStation`.
   - Muestra los datos en un embed.

3. **`createEmbed(station)`**:
   - Formatea los datos de la estaci贸n en un embed de Discord.
   - Incluye campos para estado, conexiones, servicios, accesibilidad, comercios y comuna.

#### **Flujo de Trabajo Ejemplo:**

1. **Entrada del Usuario:** `/estacion San Pablo L1`
2. **Funci贸n `execute`:**
   - Analiza la consulta en `name = "San Pablo"` y `line = "1"`.
   - Llama a `deepSearch("San Pablo", { lineFilter: "1" })`.
   - Obtiene datos detallados utilizando `getStation("sanpablol1")`.
   - Muestra el embed.

#### **Ejemplo de Embed:**

```
 San Pablo L1 (L铆nea 1)
---------------------------------
Estado:  Operativa
Conexiones: L5
Servicios: ATM, WiFi
Accesibilidad: Accesible
Comercios: Cafeter铆a, Tienda
Comuna: Santiago
```

---

### **Flujo de Datos**

1. **Interacci贸n del Usuario:**
   - El usuario escribe `/estacion San Pablo L1` en Discord.

2. **Autocompletado:**
   - La funci贸n `autocomplete` llama a `deepSearch("San Pablo")`.
   - Devuelve sugerencias como `San Pablo L1`, `San Pablo L5`.

3. **Ejecuci贸n del Comando:**
   - La funci贸n `execute` analiza la consulta y llama a `deepSearch("San Pablo", { lineFilter: "1" })`.
   - Obtiene datos detallados utilizando `getStation("sanpablol1")`.
   - Muestra el embed.

4. **B煤squeda y Coincidencias:**
   - `deepSearch` utiliza `getAllStations` para acceder a todos los datos de las estaciones.
   - Aplica coincidencias exactas, parciales y fon茅ticas para encontrar los mejores resultados.

5. **Obtenci贸n de Datos:**
   - `getStation` recupera datos detallados de la estaci贸n desde la cach茅 preprocesada.

---

### **Caracter铆sticas Clave**

1. **Manejo Eficiente de Datos:**
   - Los datos de las estaciones se preprocesan y almacenan en cach茅 para un acceso r谩pido.
   - Admite coincidencias exactas, parciales y fon茅ticas.

2. **B煤squeda Flexible:**
   - Maneja consultas con o sin sufijos de l铆nea (por ejemplo, "San Pablo L1").
   - Admite desambiguaci贸n para consultas ambiguas.

3. **Salida Amigable para el Usuario:**
   - Muestra la informaci贸n de la estaci贸n en un embed limpio y formateado.
   - Proporciona sugerencias de autocompletado para facilitar su uso.

---

### **C贸mo Usarlo en Otros Archivos**

Para utilizar este sistema en otros archivos, sigue estos pasos:

1. **Importar los M贸dulos Necesarios:**
   - Importa `searchUtils`, `dataUtils`, y `stationUtils` en tu archivo.

   ```javascript
   const { deepSearch } = require('./utils/searchUtils');
   const { getStation, getAllStations } = require('./utils/dataUtils');
   const { createEmbed } = require('./utils/stationUtils');
   ```

2. **Realizar una B煤squeda:**
   - Usa `deepSearch` para buscar estaciones.

   ```javascript
   const matches = await deepSearch("San Pablo", { maxResults: 5 });
   ```

3. **Obtener Detalles de una Estaci贸n:**
   - Usa `getStation` para obtener informaci贸n detallada de una estaci贸n.

   ```javascript
   const station = getStation("sanpablol1");
   ```

4. **Mostrar la Informaci贸n en un Embed:**
   - Usa `createEmbed` para formatear y mostrar la informaci贸n de la estaci贸n.

   ```javascript
   const embed = createEmbed(station);
   interaction.followUp({ embeds: [embed] });
   ```

5. **Manejar Autocompletado:**
   - Usa `deepSearch` en la funci贸n `autocomplete` para proporcionar sugerencias.

   ```javascript
   async function autocomplete(interaction) {
       const query = interaction.options.getFocused();
       const matches = await deepSearch(query, { maxResults: 25 });
       await interaction.respond(matches.map(m => ({
           name: `${m.name} (L铆nea ${m.line})`,
           value: m.name
       })));
   }
   ```

---

### **Conclusi贸n**

Este sistema est谩 dise帽ado para proporcionar una experiencia robusta y amigable para buscar y mostrar informaci贸n de estaciones de metro. Al separar las responsabilidades en `dataUtils`, `searchUtils` y `stationUtils`, el c贸digo es modular, mantenible y escalable. Cada m贸dulo desempe帽a un papel espec铆fico en el flujo de datos, asegurando resultados eficientes y precisos para el usuario.
